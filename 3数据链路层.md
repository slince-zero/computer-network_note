## 3.1数据链路层概述

* **链路**（Link）就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点
* **数据链路**（Data Link）是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
* 数据链路层以**帧**为单位传输和处理数据

- 数据链路层三个重要的问题：
	- 封装成帧
	- 差错检测
	- 可靠传输（尽管误码是不能完全避免的，但若能实现发送方发送什么，接收方就能接收到什么，就称为可靠传输）
- 使用点对点信道的数据链路层
- 使用广播信道的数据链路层（共享式局域网）

## 3.2封装成帧

- 封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧。
	- 帧头和帧为包含有重要的控制信息
	- 帧头和帧尾的作用之一就是**帧定界**
- 透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样
	- 面向字节的物理链路使用字节填充（字符填充）的方式实现透明传输
	- 面向比特的物理链路使用比特填充的方法实现透明传输
- 为了提高帧的传输效率，应当使**帧的数据部分的长度尽可能大些**
- 考虑到差错控制等多种因素，每一种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元**（Maximum Transfer Unit）

## 3.3差错检测

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错：1可能会变成0，而0可能变成1，这称为**比特差错**
- 在一段时间内，传输错误的比特所占传输比特总数的比特率又称为**误码率**BER（Bit Error Rate）
- 使用**差错检测码**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

* 奇偶校验
	* 在待发送的数据后面**添加1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中**“1”的个数**为奇数（奇校验）或偶数（偶校验）
	* 如果有**奇数个位发生误码**，则奇偶性发生变化，**可以检查出误码**
	* 如果有**偶数个位发生误码**，则奇偶性不发生变化，**不能检测出误码（漏检）**

* 循环冗余校验（Cyclic Redundancy Check）
	* 接收双方约定好一个**生成多项式**G（x）
	* 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输数据的后面一起传输
	* 接收方通过生成多项式来计算收到的数据是否产生了误码
	* **检错码**只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此**无法纠正错误**
	* 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，因此在**计算机网络中较少使用**
	* 循环冗余校验**CRC**有很好的检错能力（**漏检率非常低**），虽然计算比较复杂，但非常**易于用硬件实现**，因此**广泛应用于数据链路层**
	* 在计算机网络中通常采用**检错重传方式来纠正传输中的差错，或者仅仅是丢弃检测到差错的帧**，这取决于数据链路层向上层提供的可靠性传输服务还是不可靠传输服务

##3.4.1 可靠传输的基本概念

* 使用**差错检测技术**（例如循环冗余校验CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了**误码**（比特错误）
* 数据链路层向上层提供的服务类型
	* **不可靠传输**：**仅仅丢弃有误码的帧**，其他什么也不做
	* **可靠传输**：想办法实现**发送端发送什么，接收端就收到什么**

* 一般情况下，**有线线路**的误码率比较低，为了减小开销，并**不要求数据链路层**向上提供**可靠**传输服务。即使出现了误码，可靠传输的问题由其他上层处理
* **无线线路**易受干扰，误码率比较高，因此**要求数据链路层**必须向上层提供**可靠**传输服务

* **比特差错**只是传输差错中的一种
* 从整个计算机网络体系结构来看，传输差错还包括**分组丢失、分组失序、分组重复**
* 分组丢失、分组失序、分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层
* **可靠传输服务并不仅局限于数据链路层**，其他各层均可实现可靠传输

		* TCP向其上层提供面向连接的不可靠传输服务
		* UDP向其上层提供无连接的不可靠传输服务
		* IP向其上层提供无连接的不可靠传输服务
* 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求

##3.4.2 可靠传输的实现机制——停止-等待协议

	停止-等待协议、回退N帧协议GBN、选择重传协议SR
	这三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系
	结构的各层协议中

![](/Users/zhangbowen/Desktop/计算机网络/04.jpeg)

![](/Users/zhangbowen/Desktop/计算机网络/05.jpeg)

## 3.4.3 可靠传输的实现机制——回退N帧协议

![](/Users/zhangbowen/Desktop/计算机网络/06.jpeg)

* 回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续的ARQ协议【自动重传请求（Automatic Repeat-reQuest，ARQ）】
* 在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为画的窗口协议
* 由于回退N帧协议的特性，当通信线路质量不好时，其信道利用率并不比停止-等待协议高


##3.4.4 可靠传输的实现机制-选择重传协议

- **回退N帧协议**的接收窗口尺寸**WR只能等于1**，因此**接收方只能按序接收正确到达的数据分组**
- 一个数据分组的误码就会导致其后续多个数据分组不能被接收方按序接收而丢弃（尽管它们无乱序和误码）。这必须会造成发送方对这些数据分组的超时重传，显然这是对通信资源的极大浪费
- 为了进一步提高性能，可设法只重传出现误码的数据分组。因此，接收窗口的尺寸**WR不应该再等于1（而应大于1）**，以便**接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组**，等到所缺分组收齐后再一并递交上层。这就是**选择重传协议**

		注意：选择重传协议 为了使发送方仅重传出现差错的分组，接收方 不能再采用累积
		确认，而需要对每个正确接收到的数据分组进行 逐一确认！


![](/Users/zhangbowen/Desktop/计算机网络/07.jpeg)

##3.5 点对点协议

* 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路协议
* PPP协议是因特网工程任务组IETF再1992年定制的。经过1993年和1994年的修订，现在PPP协议已经成为因特网的正式标准「RFC1661、RFC1662」
![](/Users/zhangbowen/Desktop/计算机网络/08.jpeg)

![](/Users/zhangbowen/Desktop/计算机网络/09.jpeg)

* 实现透明传输的方法：
	* 面向字节的异步链路：字节填充法（插入“转义字符”）
	* 面向比特的同步链路：比特填充法（插入“比特0”）

![](/Users/zhangbowen/Desktop/计算机网络/10.jpeg)

![](/Users/zhangbowen/Desktop/计算机网络/11.jpeg)

##3.6.1 媒体接入控制的基本概念
- 共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**（Medium Access Control）

* 媒体接入控制：
	* 静态划分信道：
		预先固定分配好信道，这类方法非常不灵活，对于突发性数据传输信道利用率会很低。通常在无线网络的物理层中使用，而不是在数据链路层中使用
		* 频分多址
		* 时分多址
		* 码分多址
	* 动态接入控制：
		* 受控接入：
			* 集中控制：有一个主战以循环方式轮询每个站点有无数据发送，只有被轮询到的站点才能发送数据，最大的缺点是存在单点故障问题
			* 分散控制：各站点是平等的，并连接成一个环形网络。令牌（一个特殊的控制帧）沿环逐站传递，接收到令牌的站点才有权发送数据，并在发送完数据后将令牌传递给下一个占点
		* 随机接入：所有站点通过竞争，随机地在信道上发送数据。如果恰巧有两个或更多的站点在同一时刻发送数据，则信号在共享媒体上就要产生碰撞（即发送冲突），使得这些站点的发送都失败。因此这类协议要解决的关键问题是如何尽量避免冲突，以及在冲突后尽快恢复通信，著名的共享式以太网采用的就是随机接入
	
				随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点
				对点链路和链路层交换机的交换式局域网在有线领域以及完全取代了共享
				式局域网，但由于无线信道的广播天性，无线局域网使用的仍然是共享媒
				体技术
				
				
##3.6.2 媒体接入控制——静态划分信道

### 信道复用

* 复用（Multiplexing）：指通过一条物理线路同时传输多路用户的信号
* 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽


![](/Users/zhangbowen/Desktop/计算机网络/12.png)

##3.6.3 媒体接入控制——动态接入控制——随机接入

###载波监听 多址接入/ 碰撞检测 CS MA /CD	

- 多址接入MA：多个站连接在一条总线上，竞争使用总线
- 载波监听CS：每一个站在发送帧之前先要检测一下总线是否有其他站点在发送帧（先听后说）
	- 若检测到总线空闲96比特时间，则发送这个帧
	- 若检测到总线忙，则继续检测并等待总线转化为空闲96比特时间，然后发送这个帧
- 碰撞检测CD：每一个正在发送帧的站 边发送边检测碰撞（边说边听）
	- 一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后再次发送（一旦冲突，立即停说，等待时机，重新再说）


###CSMA/CD协议——争用期（碰撞窗口）
* 主机最多经过2τ（δ趋于0）的时长就可检测到本次发送是否遭受了碰撞
* 因此，以太网的端到端往返传播时延2τ称为**争用期**或**碰撞窗口**
* 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
* 每一个主机在字节发送帧之后的一小段时间内，存在遭遇碰撞的可能性。这一小段时间是不确定的，它取决于另一个发送帧的主机到本主机的距离，但不会超过总线的端到端往返传播时延，即一个争用期时间
* 显然，在以太网中发送帧的主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此**共享式以太网不能连接太多的主机，使用的总线也不能太长**
	* 10Mb/s 以太网把争用期定位512比特发送时间，即51.2μs，因此其总线长度不能超过5120m，但考虑到其他一些因素，如信号衰减等，以太网规定总线长度不能超过2500m

###CSMA/CD协议——最小帧长
* **以太网规定最小帧长为64字节**，即512比特（512比特时间即为争用期）
	* 如果要发送的数据非常少，那么必须加入一些填充字节，使帧长不小于64字节
* 以太网的**最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞**
	* 如果在争用期（共发送64字节）没有检测到碰撞，那么后续发送的数据就一定不会发生碰撞
	* 如果在争用期内检测到碰撞，就立即中止发送，这时已发送出去的数据一定小于64字节，因此，**凡长度小于64字节的帧都是由于碰撞而异常中止的无效帧**
![](/Users/zhangbowen/Desktop/计算机网络/13.jpeg) 

![](/Users/zhangbowen/Desktop/计算机网络/14.jpeg) 				
				
			
CSMA/CD协议曾经用于各种总线结构以太网和双绞线以太网的早期版本中
现在的以太网基于交换机和全双工连接，不会有碰撞，因此，没有必要使用CSMA/CD协议
				
				
##3.6.4 媒体接入控制——动态接入——随机接入
### 载波监听多址接入/碰撞避免CSMA/CA（Carrier Sense Multiple Access/Colosion Avoidance）

* **在无线局域网中，仍然可以使用载波监听多址接入CSMA**，即在发送帧之前先对媒体进行载波监听。若发现有其他站在发送帧，就推迟发送以免发生碰撞
* **在无线局域网中，不能使用碰撞检测CD**，原因：
	* 由于无线信道的传输条件特殊，其信号强的动态范围非常大，无线网卡接收到的信号强度往往会远远小于发送信号的强度（可能相差百万倍）。**如果要在无线网卡上实现碰撞检测CD，对硬件要求非常高**
	* 即使能够在硬件上实现无线局域网的碰撞检测，但由于无线电波传播的特殊性**（存在隐蔽站问题），进行碰撞检测的意义也不大**			
	
* **802.11无线局域网**使用CSMA/CA协议，在CSMA的基础上增加了一个**碰撞避免CA功能**，而不再实现碰撞检测功能
* 由于**不可能避免所有的碰撞**，并且**无线信道误码率较高**，802.11标准使用了**数据链路层确认机制（停止—等待协议）**来保证数据被正确接收
* 802.11的MAC层标准定义了两种不同的媒体接入控制方式：
	* **分布式协调功能DCF**（Distributed Coordination Function）。在DCF方式下，没有中心控制站点，每个站点使用CSMA/CA协议通过争用信道来获取发送权，这是802.11定义的默认方式
	* **点协调功能PCF**（Point Coordination Function）。PCF方式使用集中控制的接入算法（一般在接入点AP实现集中控制），是802.11定义的可选方式，在实际中较少使用			

###帧间间隔IFS（InterFrame Space）
* 802.11标准规定，所有的**站点必须在持续检测到信道空闲一段指定时间后才能发送帧**，这段时间称为帧间间隔IFS
* 帧间间隔的长短取决于该站点要发送的帧的类型：
	* 高优先级帧需要等待的时间较短，因此可优先获得发送权
	* 低优先级帧需要等待时间较长，若某个站的低优先级帧还没来得及发送，而其他站的高优先级帧已发送到信道上，则信道变为忙态，因而低优先级帧就只能再推迟发送了。这样就减少了发生碰撞的机会
* 常用的两种帧间间隔：
	* **短帧间间隔SIFS**（28 μs），是最短的帧间间隔，用来分隔开术语一次对话的各帧。一个站点应当能够在这段时间内从发送方式切换到接收方式。使用SIFS的帧类型有ACK帧、CTS帧，由过长的MAC帧分片后的数据帧、以及所有回答AP探询的帧和在PCF方式中接入点AP发送出的任何帧
	* **DCF帧间间隔DIFS**（128 μs），在DCF方式中用来发送数据帧和管理帧

![](/Users/zhangbowen/Desktop/计算机网络/16.jpeg) 
				
###CSMA/CA协议的退避算法
* 在执行退避算法时，站点为退避计时器设置一个随机的退避时间：
	* 当退避计时器的时间减小到0时，就开始发送数据
	* 当退避计时器的时间还未减小到0时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过时间DIFS后，继续启动退避计时器
* 在进行第 i 次退避时，退避时间在时隙编号「0，1，....2^(2+i)-1 」中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。这样做是为了使不同站点选择相同退避时间的概率得到减少。当时隙编号达到255时（对应第6次退避），就不再增加了				
![](/Users/zhangbowen/Desktop/计算机网络/15.jpeg) 
![](/Users/zhangbowen/Desktop/计算机网络/18.jpeg) 
				
##3.7.1 MAC地址

* MAC地址是以太网的MAC子层所使用的地址【数据链路层】
* IP地址是TCP/IP体系结构网际层所使用的地址；ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址【网际层】
* 尽管IP地址和ARP协议属于TCP/IP体系结构的网际层（而不属于数据链路层），但是它们与MAC地址岑在一定的关系，并且我们日常的网络应用都离不开MAC地址、IP地址以及ARP协议。

- 当多个主机连接到同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址
- 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC（Media Access Control），因此又被称为MAC地址
	- MAC地址一般被固化在网卡（网络适配器）的电可擦编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**
	- MAC地址有时也被称为**物理地址**。**注意：这并不意味着MAC地址属于网络体系结构中的物理层！！**
- 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有全球唯一的一个MAC地址，而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。**严格来说，MAC地址是对网络上各类接口的唯一标识，而不是对网络上各设备的唯一标识**


##3.7.2 IP地址

- IP地址是因特网（Internet）上主机和路由器所使用的地址，用于标识两部分信息：
	- 网络编号：标识因特网上数以百万计的网络
	- 主机编号：标识同一网络上不同的主机（或路由器各接口）
- 显然，MAC地址不具备区分不同网络的功能
	- 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址（这不是一般用户的应用方式）
	- 如果主机所在网络要接入因特网，则IP地址和MAC地址都需要使用
	
### 数据包转发过程中IP地址与MAC地址的变化情况

- 数据包转发过程中**源IP地址和目的IP地址保持不变**
- 数据包转发过程中**源MAC地址和目的MAC地址逐个链路（逐个网络）改变**

##3.7.3 地址解析协议ARP

目的：如何通过IP地址找到其对应的MAC地址
- 源主机在自己的**ARP高速缓存表**中查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则**发送ARP请求（封装在广播MAC帧中）**
- 目的主机收到ARP请求后，然后给源主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后给源主机发送**ARP响应（封装在单播MAC帧中）**，ARP响应中包含有目的主机的IP地址和MAC地址
- 源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想要发送的MAC帧并发送给目的主机
- **ARP的使用范围：逐段链路或逐个网络使用**
- **除ARP响应和请求外，ARP还有其他类型的报文**（例如用于检查IP地址冲突的“无故ARP、免费ARP”）
- ARP没有安全验证机制，**存在ARP欺骗（攻击）问题**


##3.8 集线器与交换机的区别
###使用双绞线和集线器HUB的星型以太网
* **使用集线器的以太网在逻辑上仍然是一个总线网**，各站共享总线资源，**使用的还是CSMA/CD协议**
* **集线器只工作在物理层**，它的每个接口仅简单地转发比特，不进行碰撞检测（由各站的网卡检测）
* **集线器一般都有少量的容错能力和网络管理功能**。例如，若网络中某个网卡出了故障，不停的发送帧。此时，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网仍能正常工作

###以太网交换机
* 以太网交换机通常有**多个接口**，每个接口都可以直接与另一台主机或另一个以太网交换机相连。一般都工作在**全双工方式**
* 以太网交换机具有并行性，能**同时连通多对接口，**使多主机能同时通信**无碰撞**（不能使用CSMA协议）
* 以太网交换机一般都具有多种速率的接口，例如：10Mb/s、100Mb/s、1Gb/s接口的组合
* 以太网交换机**工作在数据链路层**（也包括物理层），它收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号，**然后通过该接口转发帧
* 以太网交换机是一种即插即用的设备，其内部的**帧交换表**是通过**自学习算法**自动地逐渐建立起来的
* 帧的两种转发方式：
	* **存储转发**
	* **直接交换**：采用基于硬件的交叉矩阵（交换时延非常小，但不检查是否有差错）

###对比集线器和交换机
* 集线器HUB：
	* 早期以太网的互联设备
	* 工作在OSI体系结构的物理层
	* 对接收到的信号进行放大、转发
	* 使用集线器作为互连设备的以太网仍然属于共享总线式以太网。集线器互连起来的所有主机共享总线带宽，属于同一个碰撞和广播域

* 交换机SWITCH：
	* 目前以太网中使用最广泛的互连设备
	* 工作在OSI体系结构的数据链路层（也包括物理层）
	* 根据MAC地址对帧进行转发
	* 使用交换机作为互连设备的以太网，称为交换式以太网。交换机可以根据MAC地址过滤帧，即隔离碰撞域
	* 交换机的每个接口是一个独立的碰撞域
	* 交换机隔离碰撞域但不隔离广播域（VLAN除外）
	
	
	
##3.9 以太网交换机自学习和转发帧的流程
* 以太网交换机工作在**数据链路层**（也包括物理层）
* 以太网交换机在收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧
* 以太网交换机是一种即插即用设备，刚上电启动时其内部的帧交换表是空的。随着网络中各主机间的通信，以太网交换机通过**自学习算法**自动逐渐**建立起帧交换表**
* 以太网交换机自学习和转发帧流程：
	1. 收到帧后进行**登记**。登记的内容为**帧的源MAC地址**以及进入交换机的接口号
	2. 根据**帧的目的MAC地址**和交换机的**帧交换表**对帧进行**转发**，有三种情况：
		- **明确转发**：交换机知道从哪个（或哪些）接口转发该帧（单播、广播、多播）
		- **盲目转发**：交换机不知道应从哪个端口转发帧，只能将其通过除进入交换机的接口外的其他所有接口转发（也称为泛洪）
		- **明确丢弃**：交换机知道不应该转发该帧，将其丢弃

* 帧交换表中每条记录都有自己的**有效时间**，到期删除。原因：
	- 交换机的接口该接了另一台主机
	- 主机更换了网卡

	
##3.10 以太网交换机的生成树协议STP
	如何提高以太网的可靠性？

* 添加**冗余链路**可以提高以太网的可靠性
* 但是，冗余链路会带来负面效应——形成**网络环路**
* 网络环路会带来以下问题：
	* **广播风暴**：大量消耗网络资源，使得网络无法正常转发其他数据帧
	* **主机收到重复的广播帧**：大量消耗主机资源
	* **交换机的帧交换表震荡（飘移）**

- 以太网交换机使用**生成树协议STP**（Spanning Tree Protocol），可以在增加冗余链路来提高网络可靠性的同时又**避免网络环路带来的各种问题**
	- 不论交换机之间采用怎样的物理连接，交换机都能**自动计算并构建一个逻辑上没有环路的网络**，其逻辑拓扑结构必须是树型的（无逻辑环路）
	- 最终生成的树型逻辑拓扑要**确保连通整个网络**
	- 当首次连接交换机或网络**物理拓扑发生变化**时（有可能是人为改变或故障），交换机都将进行**生成树的重新计算**

##3.11.1 虚拟局域网VLAN概述

* 以太网交换机工作在**数据链路层**（也包括物理层）
* 使用一个或多个以太网交换机互连起来的交换式以太网，其所有站点都属于**同一个广播域**
* 随着交换式以太网规模的扩大，广播域相应扩大**
* 巨大的广播域会带来很多**弊端**：
	* 广播风暴
	* 难以管理和维护
	* 潜在的安全问题

分割广播域的方法：

* 使用路由器可以隔离广播域
	* 路由器成本高
* 虚拟局域网VLAN技术

* 虚拟局域网VLAN（Virtual Local Area Network）是一种将局域网内的**设备划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求

##3.11.2 虚拟局域网VLAN的实现机制


![](/Users/zhangbowen/Desktop/计算机网络/19.jpeg) 








				
				
				
				
				
				
				
