##5.1 运输层概述
* 之前课程所介绍的计算机网络体系结构中的物理层、数据链路层、以及网络层它们共同解决了将主机通过异构网络互连起来所面临的问题，**实现了主机到主机的通信**
* 但实际上在计算机网络中进行**通信的真正实体是位于通信两端主机中的进程**
* **如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务**，运输层的协议又称为端到端协议
* 运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑、所采用的路由选择协议等），它使用应用进程看见的就**好像是在两个运输层实体之间有一条端到端的逻辑通信信道**
* 根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输协议，即**面向连接的TCP**和**无连接的UDP**。


##5.2 运输层端口号、复用、分用的概念
  
 * 运行在计算机上的进程使用**进程标识符PID**来标识
 * 因特网上的计算机并不是使用统一的操作系统，不同的操作系统（Windows、Linux、macOS）又使用**不同格式的进程标识符**
 * 为了使运行在不同操作系统的计算机的应用进程之间能够进行网络通信，就必须使用**统一的方法对TCP/IP体系的应用进程进行标识**
 * TCP/IP体系的运输层使用**端口号**来区分应用层的不同应用进程
 	* 端口号使用**16比特表示**，取值范围为0～65535:
 		* 熟知端口号：0～1023，IANA把这些端口号指派给了TCP/IP中最重要的一些应用协议。例如：FTP使用21/20，HTTP使用80，DNS使用53
 		* 登记端口号：1024～49151，为没有熟知端口号的应用程序使用。使用这类端口号必须在IANA按照规定的手续登记，以防重复。例如，Microsoft RDP微软远程桌面使用的端口号是3389
 		* 短暂端口号：49152～65535，留给客户进程选择暂停使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可提供给其他客户进程以后使用
 * **端口号只具有本地意义**，即端口号指示为了**标识本计算机应用层中的各进程**，在因特网中，**不同计算机中的相同端口号是没有联系的**

 ![](/Users/zhangbowen/Desktop/计算机网络/24.jpeg)


##5.3 UDP和TCP的对比
* 用户数据协议UDP（User Datagram Protocol）：
	* 无连接
	* 支持一对一，一对多，多对一和多对多交互通信
	* 对应用层交付的报文直接打包
	* 尽最大努力交付，也就是不可靠；不使用流量控制和拥塞控制
	* 首部开销小，仅8字节
* 传输控制协议TCP（Transmission Control Protocol）：
	* 面向连接
	* 每一条TCP连接只能有两个端点EP，只能是一对一通信
	* 面向字节流
	* 可靠传输，使用流量控制和拥塞控制
	* 首部最小20字节，最大60字节

##5.4 TCP的流量控制
* 一般来说，我们总是希望数据传输的更快一些
	* 但是如果发送方把数据发送的过快，接收方就可能来不及接收，这就会造成数据的丢失
* 所谓流量控制（flow control）就是**让发送方的发送速率不要太快，要让接收方来得及接收**
* 利用**滑动窗口**机制可以很方便地在TCP连接上实现对发送方的流量控制
	* TCP接收方利用自己的**接收窗口**的大小来限制**发送窗口**的大小
	* TCP发送方收到接收方的**零窗口通知**后，应启动**持续计时器**，持续计时器超时后，向接收方发送**零窗口探测报文**

##5.5 TCP的用色控制
* 在某段时间，若**对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏**。这种情况就叫做**拥塞**（congestion）
	* 计算机网络中的链路容量（即带宽）、交换结点中的缓存和处理机等，都是网络的资源
* 若**出现拥塞而不进行控制**，整个网络的**吞吐量将随输入负荷的增大而下降**

* 发送方维护一个叫做**拥塞窗口cwnd**的状态变量，其值**取决于网络的拥塞程度**，并且**动态变化**
	* 拥塞窗口**cwnd的维护原则**：只要网络**没有出现拥塞，拥塞窗口**就再**增大**一些；但只要网络**出现拥塞，拥塞窗口就减少一些**
	* 判断出现**网络拥塞的依据**：没有按时收到应当到达的确认报文（即**发生超时重传**）
* 发送方将拥塞窗口作为**发送窗口swnd**，即**swnd = cwnd**
* 维护一个慢开始门限**ssthresh**状态变量：
	* 当cwnd < ssthresh时，使用慢开始算法；
	* 当cwnd > ssthresh时，停止使用慢开始算法而改用拥塞避免算法；
	* 当cwnd = ssthresh时，既可使用慢开始算法，又可使用拥塞避免算法

 ![](/Users/zhangbowen/Desktop/计算机网络/25.jpeg)





##5.6 超时重传时间的选择
 ![](/Users/zhangbowen/Desktop/计算机网络/26.jpeg)

##5.7 TCP可靠传输的实现
* TCP基于**以字节为单位的滑动窗口**来实现可靠传输
	* 发送方在未收到接收方的确认时，可将发送窗口内还未发送的数据全部发送出去
	* 接收方只接收序号落入发送窗口内的数据
* 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻。**发送方的发送窗口并不总是和接收方的接收窗口**一样大
	* 网络传送窗口值需要经历一定的时间滞后，并且这个时间还是不确定的
	* 发送方还可能根据网络当时的拥塞情况适当减小字节的发送窗口尺寸
* 对于**不按序到达的数据应如何处理**，TCP并无明确规定
	* 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样做对网络资源的利用不利，因为发送方会重复传送比较多的数据
	* TCP通常对不按序到达的数据是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再**按序交付上层的应用进程**
* TCP要求接收方必须有**累积确认和捎带确认机制**，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上
	* **接收方不应过分推迟发送确认**，否则会导致发送方不必要的超时重传，这反而浪费了资源。TCP标准规定，确认推迟的时间不应超过0.5秒，若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认
	* 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据
* **TCP的通信是全双工通信**。通信中的每一方都在发送和接收报文段，因此，每一方都有自己的发送窗口和接收窗口。在说到这些窗口时，一定要弄清楚是哪一方的窗口

## 5.8.1 TCP的运输连接管理——TCP的连接建立
* TCP是面向连接的协议，它基于运输连接来传送TCP报文段
* TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程
* TCP运输连接有以下三个阶段：
	* 建立TCP连接
	* 数据传输
	* 释放TCP连接
* TCP的运输连接管理就是使运输连接的建立和释放都能正常地进行
* TCP的连接建立要解决以下三个问题：
	* 使TCP双方能够确知对方的存在
	* 使TCP双方能够协商一些参数（如最大窗口值，是否使用窗口扩大选项和时间戳选项以及服务质量等）
	* 使TCP双方能够对运输实体资源（如缓存大小，连接表中的项目等）进行分配
* TCP使用“三次握手”建立连接

 ![](/Users/zhangbowen/Desktop/计算机网络/27.jpeg)

## 5.8.2 TCP的运输连接管理——TCP的连接释放
 ![](/Users/zhangbowen/Desktop/计算机网络/28.jpeg)

## 5.9 TCP的报文段格式
* 为了实现可靠传输，TCP采用了**面向字节流**的方式
* 但TCP在发送数据时，是从发送缓存取出一部分或全部字节并给其添加一个首部使之成为**TCP报文段**后进行发送
	* 一个TCP报文段由**首部**和**数据载荷**两部分构成
	* TCP的全部功能都体现在它首部中各字段的作用



 ![](/Users/zhangbowen/Desktop/计算机网络/29.jpeg)


 
 
 
 
 
 
 
 
 
 
 
 
 